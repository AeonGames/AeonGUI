name: Build on Windows

on: [push, pull_request]

env:
  USERNAME: AeonGames
  VCPKG_EXE: C:\vcpkg\vcpkg.exe
  FEED_URL: https://nuget.pkg.github.com/AeonGames/index.json
  VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/AeonGames/index.json,readwrite;nugettimeout,900"
  VCPKG_FEATURE_FLAGS: "binarycaching,manifests,versions"
  VCPKG_VERBOSE: "1"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        compiler: [msvc]

    steps:
    - name: 'üß∞ Checkout'
      uses: actions/checkout@v2

    - name: üîÑ Update Visual Studio
      shell: pwsh
      run: |
        & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe" update --installPath "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise" --quiet --wait
      if: matrix.compiler == 'msvc'

    - name: ‚¨ÜÔ∏è Update VCPKG
      shell: pwsh
      run: |
        cd C:\vcpkg
        git pull
        .\bootstrap-vcpkg.bat
        mkdir C:\vcpkg\downloads
        curl -o C:\vcpkg\downloads\GNOME-pango-1.56.1.tar.gz "https://gitlab.gnome.org//GNOME/pango/-/archive/1.56.1/pango-1.56.1.tar.gz"
      if: matrix.compiler == 'msvc'

    - name: üì¶ Add NuGet sources
      shell: pwsh
      run: |
        .$(${{ env.VCPKG_EXE }} fetch nuget) `
          sources add `
          -Source "${{ env.FEED_URL }}" `
          -StorePasswordInClearText `
          -Name GitHubPackages `
          -UserName "${{ env.USERNAME }}" `
          -Password "${{ secrets.PAT }}"
        .$(${{ env.VCPKG_EXE }} fetch nuget) `
          setapikey "${{ secrets.PAT }}" `
          -Source "${{ env.FEED_URL }}"
      if: matrix.compiler == 'msvc'

    - name: 'üõ†Ô∏è Configuring'
      run: cmake -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" -B ${{github.workspace}}/build
      if: matrix.compiler == 'msvc'

    - name: 'üèóÔ∏è Building'
      run: cmake --build ${{github.workspace}}/build

    - name: 'üß™ Running Tests'
      run: ctest --output-on-failure --verbose -C Debug --test-dir ${{github.workspace}}/build
